<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>Nowe ogloszenie</title>
 
    <style>
   
        .form {
            display: flex;
            flex-direction: column;
            max-width: 50vw;
            margin: 0 auto;
        }
        .images {
            max-width: 50vw;
            margin: 0;
            padding: 0;
            width: 100%;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            display: grid;
            grid-template-columns: repeat(auto-fill,100px);
            grid-auto-rows: 10px;
            justify-content: center;
        }
        .card {
                display: flex;
                justify-content: center;
                margin: 5px;
                overflow: hidden;
                position: relative;
                cursor: pointer;
                grid-row-end: span 11;
            }
        @media screen and (max-width: 550px) {
            .form {
                max-width: 90vw;
            }
            .images {
                max-width: 95vw;
            }
        }


    </style>
</head>
<body style="background-color: black;min-height: 100vh;color: white;">
    <center>
        <h1>Dodaj ogloszenie</h1>
        <form  class="form" action="/upload" method="post" enctype="multipart/form-data">
            <label for="image">Wybierz zdjecia</label>
            <input type="file" name="image" multiple required id="files" />
            <input placeholder="Podaj tytul" type="text" name="title" id="title" required>
            <input placeholder="Podaj cene" type="number" name="price" id="price" required>
            <textarea placeholder="Wpisz opis" type="text" name="description" id="description" cols="30" rows="10" required></textarea>
            <button class="button" type="submit">Submit</button>
        </form>
        <h4 class="response"></h4>
        <div class="images"></div>
    </center>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        const button = document.querySelector(".button")
        const imagefile = document.querySelector('#files');
        const title = document.querySelector("#title");
        const price = document.querySelector("#price");
        const desc = document.querySelector("#description")
        const response = document.querySelector(".response")
        const formData = new FormData();
        let totalSize = 0
        const config = {
            onUploadProgress: progressEvent => response.innerText = `${Math.round((progressEvent.loaded/totalSize)*100)} % przeslane` 
        }

        imagefile.onchange = (e) => {
        
            formData.delete('image');
            let files = [...e.target.files];
            for (let item of files) {
            formData.append('image', item)
            }
            const cards = document.getElementsByClassName("card")
                Array.from(cards).forEach(card => {
                    card.remove()
                })
            const images = document.getElementsByTagName("img")
                Array.from(images).forEach(image => {
                    image.remove();
                })
            
            if(files) {
                Array.from(files).forEach((file) => {
                    const imgContainer = document.createElement("div");
                    const imga = document.createElement("img");
                    const url = URL.createObjectURL(file)
                    imga.setAttribute("src", url);
                    document.querySelector(".images").appendChild(imgContainer)
                    imgContainer.classList.add("card")
                    imgContainer.appendChild(imga)
                })
            }  
        }
        title.onchange = (e) => {
            formData.delete('title');
            formData.append('title', title.value)
        }
        price.onchange = (e) => {
            formData.delete('price');
            formData.append('price', price.value)
        }
        desc.onchange = (e) => {
            formData.delete('description');
            formData.append('description', description.value)
        }

        button.addEventListener("click", (e) => {
            e.preventDefault();
            formData.getAll("image")?.forEach(element => {
                totalSize += element.size;
            });
           
            axios.post('/upload', formData, config, {
            headers: {
                'Content-Type': 'multipart/form-data'
            }
             }).then((res) => {
                 response.innerText = res.data
                 totalSize = 0;
            }).catch(err => console.log(err))

        })
       
        const getTodoItems = async () => {
        try {
            const response = await axios.get(`https://doge-memes.com/api/auctions`);
            const todoItems = response.data;
            console.log(`GET: Here's the list of todos`, todoItems);
            return todoItems;
        } catch (error) {
            console.error(error);
        }
        }

    getTodoItems();
    </script>
</body>
</html>